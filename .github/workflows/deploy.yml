name: Deploy to Production

on:
  push:
    branches:
      - master
  workflow_dispatch:  # Allow manual trigger

env:
  DEPLOY_PATH: ~/llm-council

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            set -e
            
            echo "üì¶ Navigating to project directory..."
            cd ${{ env.DEPLOY_PATH }}
            
            echo "üîÑ Pulling latest changes from GitHub..."
            git fetch origin master
            git reset --hard origin/master
            
            echo "üîß Setting up environment..."
            # Ensure .env file exists with required variables
            if [ ! -f .env ]; then
              echo "‚ö†Ô∏è Warning: .env file not found. Please create it with OPENROUTER_API_KEY"
            fi
            
            echo "üê≥ Rebuilding Docker containers..."
            docker compose down
            docker compose build --no-cache
            docker compose up -d
            
            echo "‚è≥ Waiting for services to start..."
            sleep 10
            
            echo "üßπ Cleaning up old Docker images..."
            docker image prune -f
            
            echo "‚úÖ Deployment complete!"

      - name: Health check
        run: |
          echo "Performing health check..."
          sleep 15
          response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.SERVER_HOST }}:${{ secrets.APP_PORT }}/ || echo "000")
          if [ "$response" = "200" ]; then
            echo "‚úÖ Health check passed! Application is running."
          else
            echo "‚ö†Ô∏è Health check returned HTTP $response"
            exit 1
          fi
